# ç®¡ç†åå°é¦–é¡µ

ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬åœ¨ç®¡ç†åå°çš„é¦–é¡µå±•ç¤ºçš„éƒ½æ˜¯ä¸€äº›ç³»ç»Ÿä¿¡æ¯å’Œæ•°æ®ç»Ÿè®¡ã€‚

## ç»Ÿè®¡æ•°æ®åŠ è½½

**ç«™ç‚¹å†…å®¹ç»Ÿè®¡**ç‰ˆå—çš„æ•°æ®ï¼Œéœ€è¦é€šè¿‡æŸ¥è¯¢æ•°æ®åº“å¾—åˆ°å…·ä½“çš„æ•°å€¼ã€‚

### SQL è¯­å¥

```sql
-- æ–‡ç« æ€»æ•°:
select count(1) from posts

-- è‰ç¨¿æ€»æ•°:
select count(1) from posts where status = 'drafted'

-- åˆ†ç±»æ€»æ•°:
select count(1) from categories

-- è¯„è®ºæ€»æ•°:
select count(1) from comments

-- å¾…å®¡æ ¸çš„è¯„è®ºæ€»æ•°:
select count(1) from comments where status = 'held'
```

### æ‰§è¡Œ SQL æŸ¥è¯¢æ•°æ®

åœ¨ `index.php` é¡µé¢åŠ è½½ï¼ˆæ‰§è¡Œï¼‰è¿‡ç¨‹ä¸­é€šè¿‡ä»£ç æ‰§è¡Œ SQL è¯­å¥ï¼Œè·å–æ‰€éœ€æ•°æ®ï¼š

```php
// æŸ¥è¯¢æ–‡ç« æ€»æ•°

$connection = mysqli_connect(DB_HOST, DB_USER, DB_PASS, DB_NAME);

if (!$connection) {
  die('<h1>Connect Error (' . mysqli_connect_errno() . ') ' . mysqli_connect_error() . '</h1>');
}

if ($result = mysqli_query($connection, 'select count(1) from posts')) {
  $post_count = mysqli_fetch_row($result)[0];
  mysqli_free_result($result);
}

mysqli_close($connection);

// å…¶ä½™å‡ ä¸ªæŸ¥è¯¢åªæ˜¯æŸ¥è¯¢è¯­å¥ä¸é€šï¼Œæ‰€ä»¥è¿™é‡Œä¸åˆ—ä¸¾äº†ã€‚
```

> ğŸš© æºä»£ç : step-13

---

## å°è£…æŸ¥è¯¢å‡½æ•°

ç”±äºæ¥ä¸‹æ¥çš„æ“ä½œï¼ˆå¼€å‘ï¼‰è¿‡ç¨‹ä¸­ä¼šæœ‰å¾ˆå¤šéœ€è¦æŸ¥è¯¢æ•°æ®åº“çš„åœ°æ–¹ã€‚å¦‚æœæ¯æ¬¡éƒ½æŒ‰ç…§æœ€åŸå§‹çš„æ–¹æ³•å»å†™è¿‡äºéº»çƒ¦ã€‚æˆ‘ä»¬åº”è¯¥å°†é‡å¤çš„åœ°æ–¹æå–å‡ºæ¥ï¼Œå°è£…ä¸€ä¸ªå…¬å…±çš„ `xiu_query` å‡½æ•°ï¼Œæ–¹ä¾¿åæœŸè°ƒç”¨å’Œç»´æŠ¤ã€‚

> è¯´æ˜ï¼šç”±äº PHP å†…ç½®å‡½æ•°ç‰¹åˆ«å¤šï¼Œæˆ‘ä»¬åœ¨è‡ªå®šä¹‰å‡½æ•°æ—¶ï¼Œå‡½æ•°åç§°æœ€å¥½æœ‰ä¸ªæ€§ä¸€ç‚¹ï¼Œå¦åˆ™ä¼šå†²çªï¼ˆå†²çªäº†ä¼šæœ‰è­¦å‘Šï¼‰ã€‚

```php
/**
 * æ‰§è¡Œä¸€ä¸ªæŸ¥è¯¢è¯­å¥ï¼Œè¿”å›æŸ¥è¯¢åˆ°çš„æ•°æ®ï¼ˆå…³è”æ•°ç»„æ··åˆç´¢å¼•æ•°ç»„ï¼‰
 * @param  string $sql éœ€è¦æ‰§è¡Œçš„æŸ¥è¯¢è¯­å¥
 * @return array       æŸ¥è¯¢åˆ°çš„æ•°æ®ï¼ˆäºŒç»´æ•°ç»„ï¼‰
 */
function xiu_query ($sql) {
  // å»ºç«‹æ•°æ®åº“è¿æ¥
  $connection = mysqli_connect(DB_HOST, DB_USER, DB_PASS, DB_NAME);

  if (!$connection) {
    // å¦‚æœè¿æ¥å¤±è´¥æŠ¥é”™
    die('<h1>Connect Error (' . mysqli_connect_errno() . ') ' . mysqli_connect_error() . '</h1>');
  }

  // å®šä¹‰ç»“æœæ•°æ®å®¹å™¨ï¼Œç”¨äºè£…è½½æŸ¥è¯¢åˆ°çš„æ•°æ®
  $data = array();

  // æ‰§è¡Œå‚æ•°ä¸­æŒ‡å®šçš„ SQL è¯­å¥
  if ($result = mysqli_query($connection, $sql)) {
    // æŸ¥è¯¢æˆåŠŸï¼Œåˆ™è·å–ç»“æœé›†ä¸­çš„æ•°æ®

    // éå†æ¯ä¸€è¡Œçš„æ•°æ®
    while ($row = mysqli_fetch_array($result)) {
      // è¿½åŠ åˆ°ç»“æœæ•°æ®å®¹å™¨ä¸­
      $data[] = $row;
    }

    // é‡Šæ”¾ç»“æœé›†
    mysqli_free_result($result);
  }

  // å…³é—­æ•°æ®åº“è¿æ¥
  mysqli_close($connection);

  // è¿”å›å®¹å™¨ä¸­çš„æ•°æ®
  return $data;
}
```

> ğŸš© æºä»£ç : step-14

### æŠ½è±¡ functions.php æ–‡ä»¶

è€Œä¸”è¿™ä¸ªå‡½æ•°ä¸ä»…ä»…åœ¨å½“å‰é¡µé¢ä¼šä½¿ç”¨åˆ°ï¼Œå…¶ä»–çš„é¡µé¢ä¸­ä¹Ÿä¼šä½¿ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠè¿™ä¸ªå‡½æ•°æŠ½ç¦»åˆ°ä¸€ä¸ªå•ç‹¬çš„ `functions.php` æ–‡ä»¶ä¸­ï¼Œå¹¶å°†è¿™ä¸ªæ–‡ä»¶æ”¾åˆ°æ ¹ç›®å½•ä¸‹ï¼ˆå‰å°ä»£ç ä¹Ÿä¼šç”¨åˆ°ï¼‰ã€‚

> ğŸš© æºä»£ç : step-15

### æŠ½è±¡åˆ›å»ºæ•°æ®åº“è¿æ¥å‡½æ•°

æŒ‰ç…§ä»¥ä¸Šæ–¹æ³•å°è£…å¾ˆæ–¹ä¾¿ï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸€äº›é—®é¢˜ï¼š

1. æ— æ³•é‡ç”¨ä¸€ä¸ªæ•°æ®åº“è¿æ¥å¯¹è±¡ï¼Œæ¯æ¬¡æŸ¥è¯¢éƒ½æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°æ®åº“è¿æ¥ï¼Œéå¸¸æ¶ˆè€—èµ„æºã€‚
2. å¦‚æœå¸Œæœ›ä½¿ç”¨å…¶ä»–çš„æŸ¥è¯¢å‡½æ•°ï¼Œæ¯”å¦‚ `mysqli_fetch_assoc`ã€`mysqli_fetch_row`ã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†ä»¥ä¸Šå°è£…çš„ `xiu_query` å‡½æ•°æ‹†åˆ†æˆä¸¤ä¸ªå‡½æ•°ï¼š

1. `xiu_connect` å‡½æ•°ï¼Œç”¨äºåˆ›å»ºä¸€ä¸ªæ•°æ®åº“è¿æ¥å¯¹è±¡ï¼›
2. `xiu_query` å‡½æ•°ï¼Œæ‰§è¡Œä¸€ä¸ªæŸ¥è¯¢æ“ä½œï¼Œå¹¶è¿”å›æŸ¥è¯¢åˆ°çš„æ•°æ®ç»“æœï¼›

> ğŸš© æºä»£ç : step-16

---

## è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯

åœ¨ç®¡ç†åå°ä¸€èˆ¬æˆ‘ä»¬éƒ½éœ€è¦è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„ä¿¡æ¯ï¼Œç”¨äºç•Œé¢å±•ç¤ºå’Œåç»­ä¸šåŠ¡é€»è¾‘ï¼ˆä¾‹å¦‚æ–°å¢æ–‡ç« ï¼‰ä¸­ä½¿ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»è¦èƒ½è·å–åˆ°å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ã€‚

è€Œç™»å½•ç”¨æˆ·ä¿¡æ¯åªæœ‰åœ¨ç™»å½•è¡¨å•æäº¤é‚£æ¬¡è¯·æ±‚ä¸­çŸ¥é“ï¼Œå¦‚æœåç»­è¯·æ±‚ä¹Ÿéœ€è¦çš„è¯ï¼Œå°±å¿…é¡»å€ŸåŠ© Session å»ä¿å­˜çŠ¶æ€ï¼Œåœ¨ä¹‹å‰å¼€å‘ç™»å½•çŠ¶æ€ä¿æŒåŠŸèƒ½æ—¶ï¼Œæˆ‘ä»¬å¾€ Session ä¸­å­˜æ”¾çš„åªæ˜¯ä¸€ä¸ªæ ‡è¯†å˜é‡ï¼Œå¯ä»¥è°ƒæ•´ä¸€ä¸‹ï¼Œæ”¹ä¸ºä¿å­˜ç”¨æˆ·æ ‡è¯†ï¼ˆç”¨æˆ· IDï¼‰ï¼š

```php
// $_SESSION['is_logged_in'] = true;
// ä¿å­˜ç”¨æˆ· ID åˆ° Session ä¸­
$_SESSION['current_logged_in_user_id'] = $user['id'];
```

éœ€è¦è®¿é—®æ§åˆ¶çš„ä½ç½®ä¹Ÿéœ€è¦è°ƒæ•´ï¼š

```php
if (empty($_SESSION['current_logged_in_user_id'])) {
  ...
}
```

> ğŸš© æºä»£ç : step-17

### å°è£…è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯

æˆ‘ä»¬å¯¹è®¿é—®æ§åˆ¶é€»è¾‘ä»£ç ç¨åŠ æ”¹é€ ï¼ŒæŠ½è±¡æˆä¸€ä¸ªå…¬å…±çš„å‡½æ•°ï¼Œä¾¿äºåç»­åœ¨å…¶ä»–åœ°æ–¹å…¬ç”¨ï¼š

```php
/**
 * è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„ä¿¡æ¯
 * å¦‚æœæ²¡æœ‰è·å–åˆ°çš„è¯åˆ™è·³è½¬åˆ°ç™»å½•é¡µ
 * ä¹Ÿå¯ä»¥é€šè¿‡å…¨å±€å˜é‡è®¿é—®è¿”å›ç»“æœ
 * @return array åŒ…å«ç”¨æˆ·ä¿¡æ¯çš„å…³è”æ•°ç»„
 */
function xiu_get_current_user () {
  if (isset($GLOBALS['current_user'])) {
    // å·²ç»æ‰§è¡Œè¿‡äº†ï¼ˆé‡å¤è°ƒç”¨å¯¼è‡´ï¼‰
    return $GLOBALS['current_user'];
  }

  // å¯åŠ¨ä¼šè¯
  session_start();

  if (empty($_SESSION['current_logged_in_user_id']) || !is_numeric($_SESSION['current_logged_in_user_id'])) {
    // æ²¡æœ‰ç™»å½•æ ‡è¯†å°±ä»£è¡¨æ²¡æœ‰ç™»å½•
    // è·³è½¬åˆ°ç™»å½•é¡µ
    header('Location: /admin/login.php');
    exit; // ç»“æŸä»£ç ç»§ç»­æ‰§è¡Œ
  }

  // æ ¹æ® ID è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼ˆå®šä¹‰æˆå…¨å±€çš„ï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨ï¼‰
  $GLOBALS['current_user'] = xiu_query(sprintf('select * from users where id = %d limit 1', intval($_SESSION['current_logged_in_user_id'])))[0];

  return $GLOBALS['current_user'];
}
```

åœ¨éœ€è¦è®¿é—®æ§åˆ¶çš„ä½ç½®è°ƒç”¨ï¼Œè°ƒç”¨ä¹‹åå°±å¯ä»¥ä½¿ç”¨ `$current_user` è®¿é—®å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼š

```php
// è·å–ç™»å½•ç”¨æˆ·ä¿¡æ¯
xiu_get_current_user();

...

<!-- è®¿é—®ç™»å½•ç”¨æˆ·ä¿¡æ¯ -->
<div class="profile">
  <img class="avatar" src="<?php echo $current_user['avatar']; ?>">
  <h3 class="name"><?php echo $current_user['nickname']; ?></h3>
</div>
```

> ğŸš© æºä»£ç : step-18
